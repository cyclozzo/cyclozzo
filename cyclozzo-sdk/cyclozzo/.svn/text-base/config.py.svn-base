#! /usr/bin/env python
#
# Sandbox initialization.
#
# @author: Sreejith K
# Created on 5th April 2010

import logging
from cyclozzo.sdk.app import get_yaml, get_client

log = logging.getLogger(__name__)

class DatastoreProviderError(Exception):
	"""
	Raised when a provider is not supported by sdk.
	"""

def register_apis():
	from cyclozzo.sdk.api import apiproxy_stub_map, datastore_stub, urlfetch_stub, user_service_stub, mail_stub
	yaml = get_yaml()
	if yaml.provider == 'boost':
		db_client = get_client().hypertable()
		db_scanner = get_client().scanner()
	elif yaml.provider == 'thrift':
		db_client = get_client().thrift()
		db_scanner = None
	elif yaml.provider == 'sdk':
		db_client = get_client().sdk()
		db_scanner = None
	elif yaml.provider == 'emulator':
		db_client = get_client().emulator()
		db_scanner = None
	else:
		raise DatastoreProviderError('%s provider is not supported by sdk' %yaml.provider)

	apiproxy_stub_map.apiproxy = apiproxy_stub_map.APIProxyStubMap()
	# Register datastore api
	apiproxy_stub_map.apiproxy.RegisterStub('datastore', 
		datastore_stub.DatastoreStub(
			client=db_client,
			scanner=db_scanner))
	# Register mail api
	apiproxy_stub_map.apiproxy.RegisterStub('mail',
		mail_stub.MailServiceStub(enable_sendmail=True))
	log.debug('done configuring sandbox')
